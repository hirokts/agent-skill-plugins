#!/bin/bash
set -e

PEER_DIR=".peer-chats"
MESSAGES="$PEER_DIR/messages.md"

ACTION="${1:?Usage: peer <send|read|clear> [--name NAME] [message]}"
shift

case "$ACTION" in
  send)
    if [ "$1" = "--name" ]; then
      NAME="$2"; shift 2
    else
      echo "エラー: --name is required for send" >&2
      exit 1
    fi
    MESSAGE="$*"
    if [ -z "$MESSAGE" ]; then
      echo "エラー: メッセージを指定してください" >&2
      exit 1
    fi
    mkdir -p "$PEER_DIR"
    PREV=""
    if [ -f "$MESSAGES" ]; then
      LAST_HEADER=$(grep -n "^## " "$MESSAGES" | tail -1 | cut -d: -f1)
      if [ -n "$LAST_HEADER" ]; then
        PREV=$(tail -n +"$LAST_HEADER" "$MESSAGES")
      fi
    fi
    {
      if [ -n "$PREV" ]; then
        printf "%s\n\n" "$PREV"
      fi
      printf "## %s\n%s\n" "$NAME" "$MESSAGE"
    } > "$MESSAGES"
    echo "送信完了: $MESSAGES"
    ;;
  read)
    if [ ! -f "$MESSAGES" ]; then
      echo "まだメッセージはありません"
      exit 0
    fi
    cat "$MESSAGES"
    ;;
  clear)
    if [ -f "$MESSAGES" ]; then
      rm "$MESSAGES"
      echo "会話をリセットしました"
    else
      echo "リセットするメッセージがありません"
    fi
    ;;
  *)
    echo "エラー: 不明なアクション: $ACTION" >&2
    echo "Usage: peer <send|read|clear> [--name NAME] [message]" >&2
    exit 1
    ;;
esac
